<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
        // Global variables
        let db = null;
        let allRepairs = [];
        let filteredRepairs = [];
        let currentFilter = 'all';
        let isFirebaseInitialized = false;
        let currentLanguage = 'tr';
        let activeFormState = {};

        // Translations (Mevcut haliyle kalacak, burada yer kaplamaması için kısaltıldı)
        const translations = {
            tr: { connecting: '🔄 Bağlanıyor...', connected: '✅ Bağlandı', connectionError: '❌ Bağlantı Hatası', configError: '❌ Yapılandırma Hatası', firebaseSuccess: 'Firebase başarıyla bağlandı!', firebaseError: 'Firebase bağlantı hatası: ', dataLoadError: 'Veriler yüklenemedi: ', validImageError: 'Lütfen geçerli bir resim dosyası seçin (JPEG, PNG, GIF, WEBP).', fileSizeError: 'Dosya boyutu çok büyük (Maks. 10MB).', quantityError: 'Lütfen geçerli bir çıkan adet girin.', dateError: 'Lütfen tamamlanma tarihini girin.', photoError: 'Lütfen tamamlanan saç fotoğrafını yükleyin.', photoSetInState: '[DEBUG] Fotoğraf state içinde ayarlandı: ', photoClearedFromState: '[DEBUG] Fotoğraf state içinden temizlendi.', completing: 'Tamamlanıyor...', uploadingPhoto: 'Fotoğraf yükleniyor...', updatingRecord: 'Kayıt güncelleniyor...', repairCompleted: 'Tamir başarıyla tamamlandı!', repairError: 'Tamir tamamlanamadı: ', formCleared: 'Form temizlendi.', noRecordsFound: 'Kayıt bulunamadı', noMatchingRecords: 'Filtrelerinize uygun tamir kaydı bulunamadı.', entryDate: 'Giriş Tarihi', totalQuantity: 'Toplam Adet', set: 'Takım', deliveryDate: 'Teslim Tarihi', completedQuantity: 'Çıkan Adet', originalPhoto: 'Orijinal Fotoğraf', completedPhoto: 'Tamamlanan Saç Fotoğrafı', completionNotes: 'Tamamlama Notları', repairCompleteTitle: '🎯 Tamir Tamamlandı', completedQuantityLabel: 'Çıkan Kaynak Adedi *', completionDateLabel: 'Tamamlanma Tarihi *', completionNotesLabel: 'Tamamlama Notları', completedPhotoLabel: 'Tamamlanan Saç Fotoğrafı *', completedPhotoPlaceholder: 'Tamamlanan Saç Fotoğrafı', tapToAddPhoto: 'Dokunarak fotoğraf ekle', cancel: '❌ İptal', complete: '✅ Tamamla', pending: '⏳ Bekliyor', completed: '✅ Tamamlandı', yes: 'Evet', no: 'Hayır', unspecified: 'Belirtilmemiş', none: 'Yok', maximum: 'Maksimum', pieces: 'adet', notesPlaceholder: 'Tamir sürecinde dikkat çeken detaylar, özel durumlar vb.' },
            en: { connecting: '🔄 Connecting...', connected: '✅ Connected', connectionError: '❌ Connection Error', configError: '❌ Configuration Error', firebaseSuccess: 'Firebase connected successfully!', firebaseError: 'Firebase connection error: ', dataLoadError: 'Data could not be loaded: ', validImageError: 'Please select a valid image file (JPEG, PNG, GIF, WEBP).', fileSizeError: 'File size is too large (Max. 10MB).', quantityError: 'Please enter a valid completed quantity.', dateError: 'Please enter the completion date.', photoError: 'Please upload the completed hair photo.', photoSetInState: '[DEBUG] Photo set in state: ', photoClearedFromState: '[DEBUG] Photo cleared from state.', completing: 'Completing...', uploadingPhoto: 'Uploading photo...', updatingRecord: 'Updating record...', repairCompleted: 'Repair completed successfully!', repairError: 'Repair could not be completed: ', formCleared: 'Form cleared.', noRecordsFound: 'No records found', noMatchingRecords: 'No repair records found matching your filters.', entryDate: 'Entry Date', totalQuantity: 'Total Quantity', set: 'Set', deliveryDate: 'Delivery Date', completedQuantity: 'Completed Quantity', originalPhoto: 'Original Photo', completedPhoto: 'Completed Hair Photo', completionNotes: 'Completion Notes', repairCompleteTitle: '🎯 Repair Completed', completedQuantityLabel: 'Completed Extension Quantity *', completionDateLabel: 'Completion Date *', completionNotesLabel: 'Completion Notes', completedPhotoLabel: 'Completed Hair Photo *', completedPhotoPlaceholder: 'Completed Hair Photo', tapToAddPhoto: 'Tap to add photo', cancel: '❌ Cancel', complete: '✅ Complete', pending: '⏳ Pending', completed: '✅ Completed', yes: 'Yes', no: 'No', unspecified: 'Unspecified', none: 'None', maximum: 'Maximum', pieces: 'pieces', notesPlaceholder: 'Notable details during repair process, special conditions etc.' }
        };

        const firebaseConfig = {
            apiKey: "AIzaSyBz2qgBqPl2a24JpCiijYEAX5D3UKKpHmI",
            authDomain: "tamirizmit.firebaseapp.com",
            projectId: "tamirizmit",
            storageBucket: "tamirizmit.appspot.com",
            messagingSenderId: "1075256682215",
            appId: "1:1075256682215:web:301bb62040ec647b2e6442",
            measurementId: "G-GKH3Z03LX3"
        };
        
        const IMGUR_CLIENT_ID = 'a81cec9889403e9';

        // === YENİ GÜVENLİK KONTROLÜ BAŞLANGICI ===
        document.addEventListener('DOMContentLoaded', function() {
            const auth = firebase.auth();
            const savedLanguage = localStorage.getItem('preferredLanguage') || 'tr';
            changeLanguage(savedLanguage, false);

            auth.onAuthStateChanged(user => {
                if (user) {
                    console.log('Kullanıcı giriş yapmış:', user.email);
                    
                    // Uygulamanın geri kalanını yükle
                    initializeFirebase();
                    
                    document.getElementById('searchInput').addEventListener('input', handleSearch);
                    document.querySelector('.close-modal').addEventListener('click', closePhotoModal);
                    document.getElementById('photo-modal').addEventListener('click', (e) => {
                        if (e.target === document.getElementById('photo-modal')) {
                            closePhotoModal();
                        }
                    });

                    // Kullanıcı bilgisi ve çıkış butonu ekle
                    const userInfoContainer = document.createElement('div');
                    userInfoContainer.innerHTML = `
                        <div style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px; color: white; z-index: 10;">
                            ${user.email} | <a href="#" id="logoutBtn" style="color:white; font-weight:bold; text-decoration:none;">Çıkış</a>
                        </div>
                    `;
                    document.querySelector('.header').appendChild(userInfoContainer);
                    
                    document.getElementById('logoutBtn').addEventListener('click', (e) => {
                        e.preventDefault();
                        auth.signOut();
                    });

                } else {
                    console.log('Kullanıcı giriş yapmamış. Yönlendiriliyor...');
                    window.location.href = 'login.html';
                }
            });
        });
        // === YENİ GÜVENLİK KONTROLÜ SONU ===

        function changeLanguage(lang, shouldReRenderRepairs = true) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);
            
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === lang.toLowerCase()) {
                    btn.classList.add('active');
                }
            });
            
            document.documentElement.lang = lang;
            
            document.querySelectorAll('[data-tr]').forEach(element => {
                const attributeKey = `data-${lang}`;
                if (element.hasAttribute(attributeKey)) {
                    const translation = element.getAttribute(attributeKey);
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = translation;
                    } else if (element.hasAttribute('title')) { 
                        element.title = translation;
                    } else {
                        element.textContent = translation;
                    }
                }
            });
            
            const titleElement = document.querySelector('title');
            if (titleElement && titleElement.hasAttribute(`data-${lang}`)) {
                titleElement.textContent = titleElement.getAttribute(`data-${lang}`);
            }

            if (shouldReRenderRepairs) {
                if (isFirebaseInitialized && allRepairs.length > 0) {
                    applyCurrentFilter(); 
                } else if (isFirebaseInitialized) {
                    const container = document.getElementById('repairs-container');
                    if (container.querySelector('.empty-state h3')) {
                         container.querySelector('.empty-state h3').textContent = t('connecting'); 
                         container.querySelector('.empty-state p').textContent = t('dataLoadError').split(':')[0]; 
                    }
                }
            }
        }

        function t(key) {
            return translations[currentLanguage]?.[key] || translations['tr']?.[key] || key;
        }

        function initializeFirebase() {
            const statusText = document.getElementById('status-text');
            const connectionStatusDiv = document.getElementById('connection-status');
            statusText.textContent = t('connecting'); 

            if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                showMessage(t('configError'), 'error', 10000);
                statusText.textContent = t('configError');
                connectionStatusDiv.className = 'connection-status status-offline';
                return;
            }

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                } else {
                    firebase.app(); 
                }

                db = firebase.firestore();
                isFirebaseInitialized = true;

                showMessage(t('firebaseSuccess'), 'success');
                statusText.textContent = t('connected');
                connectionStatusDiv.className = 'connection-status status-online';
                
                loadRepairs();

            } catch (error) {
                console.error("Firebase initialization error:", error);
                showMessage(t('firebaseError') + error.message, 'error', 10000);
                statusText.textContent = t('connectionError');
                connectionStatusDiv.className = 'connection-status status-offline';
            }
        }

        function loadRepairs() {
            if (!isFirebaseInitialized) return;

            const container = document.getElementById('repairs-container');
            if (!allRepairs.length) { 
                 container.innerHTML = `<div class="empty-state"><div class="loading"></div><h3>${t('connecting')}</h3><p>${t('dataLoadError').split(':')[0]}</p></div>`;
            }

            db.collection('repairs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                allRepairs = [];
                snapshot.forEach(doc => {
                    allRepairs.push({ id: doc.id, ...doc.data() });
                });
                applyCurrentFilter(); 
            }, error => {
                console.error("Error loading repairs:", error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚠️</div>
                        <h3>${t('dataLoadError')}</h3>
                        <p>Error: ${error.message}</p>
                    </div>`;
                showMessage(t('dataLoadError') + error.message, 'error');
            });
        }

        function filterRepairs(newFilterType, event) {
            currentFilter = newFilterType;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
             if (event && event.currentTarget) { 
                event.currentTarget.classList.add('active');
            } else {
                const activeButton = Array.from(document.querySelectorAll('.filter-btn')).find(btn =>
                    btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`filterRepairs('${newFilterType}'`)
                );
                if (activeButton) activeButton.classList.add('active');
            }
            
            applyCurrentFilter();
        }

        function applyCurrentFilter() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            filteredRepairs = allRepairs.filter(repair => {
                const customerFullName = `${repair.firstName || ''} ${repair.lastName || ''}`.toLowerCase();
                const matchesSearch = !searchTerm || 
                    customerFullName.includes(searchTerm) ||
                    (repair.phone && repair.phone.toLowerCase().includes(searchTerm));
                
                const isCompleted = repair.status === 'completed' || (repair.completedQuantity !== undefined && repair.completedQuantity !== null);
                const matchesStatus = currentFilter === 'all' || 
                    (currentFilter === 'pending' && !isCompleted) ||
                    (currentFilter === 'completed' && isCompleted);
                
                return matchesSearch && matchesStatus;
            });
            
            displayRepairs();
        }

        function handleSearch() {
            applyCurrentFilter();
        }

        function displayRepairs() {
            const container = document.getElementById('repairs-container');
            
            if (filteredRepairs.length === 0 && isFirebaseInitialized) { 
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <h3>${t('noRecordsFound')}</h3>
                        <p>${t('noMatchingRecords')}</p>
                    </div>`;
                return;
            }
             if (!isFirebaseInitialized && !allRepairs.length) { 
                container.innerHTML = `<div class="empty-state"><div class="loading"></div><h3>${t('connecting')}</h3><p>${t('dataLoadError').split(':')[0]}</p></div>`;
                return;
            }
            
            container.innerHTML = ''; 
            filteredRepairs.forEach(repair => {
                const card = createRepairCard(repair);
                container.appendChild(card);
            });
        }

        function createRepairCard(repair) {
            const card = document.createElement('div');
            const isCompleted = repair.status === 'completed' || (repair.completedQuantity !== undefined && repair.completedQuantity !== null);
            card.className = `repair-card ${isCompleted ? 'completed' : ''}`;
            
            card.addEventListener('click', function(event) {
                if (event.target.closest('button, input, textarea, .photo-upload, img, a, .detail-icon, .form-group, label, .completion-form')) {
                    if (event.target.classList.contains('expand-icon') || (event.target.parentElement && event.target.parentElement.classList.contains('expand-icon'))) {
                         this.classList.toggle('expanded');
                    }
                    return; 
                }
                this.classList.toggle('expanded');
            });

            const repairDate = repair.repairDate ? new Date(repair.repairDate).toLocaleDateString(currentLanguage === 'tr' ? 'tr-TR' : 'en-US') : t('unspecified');
            const returnDate = repair.returnDate ? new Date(repair.returnDate).toLocaleDateString(currentLanguage === 'tr' ? 'tr-TR' : 'en-US') : t('unspecified');
            const formattedPhone = formatPhoneNumber(repair.phone);
            const hasSetText = repair.hasSet === 'evet' ? t('yes') : (repair.hasSet === 'hayır' ? t('no') : t('unspecified'));
            
            card.innerHTML = `
                <div class="repair-header">
                    <div class="customer-info">
                        <div class="customer-name">${repair.firstName || ''} ${repair.lastName || ''}</div>
                        <div class="customer-phone">📞 ${formattedPhone}</div>
                    </div>
                    <div class="repair-status ${isCompleted ? 'status-completed' : 'status-pending'}">
                        ${isCompleted ? t('completed') : t('pending')}
                    </div>
                    <span class="expand-icon">▼</span> 
                </div>
                
                <div class="repair-details">
                    <div class="detail-item">
                        <div class="detail-icon">📅</div>
                        <div class="detail-text">
                            <div class="detail-label">${t('entryDate')}</div>
                            <div class="detail-value">${repairDate}</div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-icon">📦</div>
                        <div class="detail-text">
                            <div class="detail-label">${t('totalQuantity')}</div>
                            <div class="detail-value">${repair.quantity || 0}</div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-icon">🔧</div>
                        <div class="detail-text">
                            <div class="detail-label">${t('set')}</div>
                            <div class="detail-value">${hasSetText}</div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-icon">📅</div>
                        <div class="detail-text">
                            <div class="detail-label">${t('deliveryDate')}</div>
                            <div class="detail-value">${returnDate}</div>
                        </div>
                    </div>
                    ${isCompleted ? `
                    <div class="detail-item">
                        <div class="detail-icon">✅</div>
                        <div class="detail-text">
                            <div class="detail-label">${t('completedQuantity')}</div>
                            <div class="detail-value">${repair.completedQuantity || 0}</div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                ${repair.photoURL ? `
                <div class="detail-item" style="margin: 15px 0;">
                    <div class="detail-icon">📷</div>
                    <div class="detail-text">
                        <div class="detail-label">${t('originalPhoto')}</div>
                        <img src="${repair.photoURL}" alt="${t('originalPhoto')}" 
                             style="max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer; margin-top: 5px;"
                             onclick="event.stopPropagation(); openPhotoModal('${repair.photoURL}')"
                             onerror="this.style.display='none'; this.parentElement.style.display='none';">
                    </div>
                </div>
                ` : ''}
                
                ${isCompleted && repair.completedPhotoURL ? `
                <div class="detail-item" style="margin: 15px 0;">
                    <div class="detail-icon">🎯</div>
                    <div class="detail-text">
                        <div class="detail-label">${t('completedPhoto')}</div>
                        <img src="${repair.completedPhotoURL}" alt="${t('completedPhoto')}" 
                             style="max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer; margin-top: 5px;"
                             onclick="event.stopPropagation(); openPhotoModal('${repair.completedPhotoURL}')"
                             onerror="this.style.display='none'; this.parentElement.style.display='none';">
                    </div>
                </div>
                ` : ''}
                
                ${isCompleted && repair.completionNotes ? `
                <div class="detail-item" style="grid-column: 1 / -1; margin: 15px 0;">
                    <div class="detail-icon">📝</div>
                    <div class="detail-text">
                        <div class="detail-label">${t('completionNotes')}</div>
                        <div class="detail-value" style="white-space: pre-wrap; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 5px;">${repair.completionNotes}</div>
                    </div>
                </div>
                ` : ''}
                
                ${!isCompleted ? `
                <div class="completion-form" id="form-${repair.id}">
                    <h4 style="margin-bottom: 15px; color: #28a745;">${t('repairCompleteTitle')}</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="completed-quantity-${repair.id}">${t('completedQuantityLabel')}</label>
                            <input type="tel" pattern="[0-9]*" id="completed-quantity-${repair.id}" min="0" max="${repair.quantity || 999}" 
                                   placeholder="${t('completedQuantity')}" required>
                            <small style="color: #6c757d; font-size: 0.8em;">${t('maximum')}: ${repair.quantity || 0} ${t('pieces')}</small>
                        </div>
                        <div class="form-group">
                            <label for="completion-date-${repair.id}">${t('completionDateLabel')}</label>
                            <input type="date" id="completion-date-${repair.id}" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="completion-notes-${repair.id}">${t('completionNotesLabel')}</label>
                        <textarea id="completion-notes-${repair.id}" 
                                  placeholder="${t('notesPlaceholder')}"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="completed-photo-${repair.id}">${t('completedPhotoLabel')}</label>
                        <div class="photo-upload" onclick="document.getElementById('photo-input-${repair.id}').click()">
                            <input type="file" id="photo-input-${repair.id}" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment" style="display: none;">
                            <div id="photo-placeholder-${repair.id}">
                                📸<br>
                                <strong>${t('completedPhotoPlaceholder')}</strong><br>
                                <small>${t('tapToAddPhoto')}</small>
                            </div>
                            <img id="photo-preview-${repair.id}" class="photo-preview" style="display:none;" alt="[${t('completedPhoto')}]">
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="cancelCompletion('${repair.id}')">
                            ${t('cancel')}
                        </button>
                        <button type="button" class="btn" onclick="completeRepair('${repair.id}')" id="complete-btn-${repair.id}">
                            ${t('complete')}
                        </button>
                    </div>
                </div>
                ` : ''}
            `;
            
            if (!isCompleted) {
                const photoInput = card.querySelector(`#photo-input-${repair.id}`);
                const previewImg = card.querySelector(`#photo-preview-${repair.id}`);
                const placeholder = card.querySelector(`#photo-placeholder-${repair.id}`);
                const completedQuantityInput = card.querySelector(`#completed-quantity-${repair.id}`);
                const completionDateInput = card.querySelector(`#completion-date-${repair.id}`);
                const completionNotesInput = card.querySelector(`#completion-notes-${repair.id}`);

                if (!activeFormState[repair.id]) {
                    activeFormState[repair.id] = { file: null, dataURL: null, quantity: '', date: '', notes: '' };
                }
                const currentRepairState = activeFormState[repair.id];

                if (currentRepairState.dataURL && previewImg && placeholder) {
                    previewImg.src = currentRepairState.dataURL;
                    previewImg.style.display = 'block';
                    placeholder.style.display = 'none';
                } else if (previewImg && placeholder) {
                    previewImg.src = ''; 
                    previewImg.style.display = 'none';
                    placeholder.style.display = 'block';
                }

                if (completionDateInput) {
                    if (currentRepairState.date) {
                        completionDateInput.value = currentRepairState.date;
                    } else { 
                        const today = new Date();
                        const offset = today.getTimezoneOffset(); 
                        const localToday = new Date(today.getTime() - (offset * 60 * 1000));
                        completionDateInput.value = localToday.toISOString().split('T')[0];
                        currentRepairState.date = completionDateInput.value; 
                    }
                }
                
                if (completedQuantityInput) {
                     completedQuantityInput.value = currentRepairState.quantity || '';
                }
                if (completionNotesInput) {
                    completionNotesInput.value = currentRepairState.notes || '';
                }

                if (photoInput) {
                    photoInput.addEventListener('change', (e) => handlePhotoInputChange(e, repair.id));
                } else { 
                    console.error(`[createRepairCard] Fotoğraf giriş elemanı (photo-input-${repair.id}) BULUNAMADI (repair ${repair.id}). ID ve kart yapısını kontrol edin.`);
                }

                if (completedQuantityInput) {
                    completedQuantityInput.addEventListener('input', e => {
                        if (!activeFormState[repair.id]) activeFormState[repair.id] = {};
                        activeFormState[repair.id].quantity = e.target.value;
                    });
                }
                
                if (completionDateInput) {
                    completionDateInput.addEventListener('change', e => { 
                        if (!activeFormState[repair.id]) activeFormState[repair.id] = {};
                        activeFormState[repair.id].date = e.target.value;
                    });
                }

                if (completionNotesInput) {
                    completionNotesInput.addEventListener('input', e => {
                        if (!activeFormState[repair.id]) activeFormState[repair.id] = {};
                        activeFormState[repair.id].notes = e.target.value;
                    });
                }
            }
            
            return card;
        }

        function handlePhotoInputChange(event, repairId) {
            console.log(`[handlePhotoInputChange] Tetiklendi - Repair ID: ${repairId}`);
            const file = event.target.files[0];
            const inputElement = event.target; 
            const cardElement = inputElement.closest('.repair-card'); 

            if (!cardElement) {
                console.error(`[handlePhotoInputChange] KRİTİK HATA: Repair ID ${repairId} için üst .repair-card elemanı bulunamadı. Fotoğraf işlevi bu kart için çalışmayabilir.`);
                showMessage(t('repairError') + ' (UI Hatası P01)', 'error'); 
                return;
            }

            const previewImg = cardElement.querySelector(`#photo-preview-${repairId}`);
            const placeholder = cardElement.querySelector(`#photo-placeholder-${repairId}`);
            
            if (!previewImg || !placeholder) {
                console.error(`[handlePhotoInputChange] KRİTİK HATA: Repair ID ${repairId} için önizleme (bulundu: ${!!previewImg}) veya yer tutucu (bulundu: ${!!placeholder}) elemanı KART İÇİNDE BULUNAMADI. ID'leri kontrol edin: photo-preview-${repairId} ve photo-placeholder-${repairId}.`);
                 showMessage(t('repairError') + ' (UI Hatası P02)', 'error'); 
            }
            
            if (!activeFormState[repairId]) {
                console.warn(`[handlePhotoInputChange] activeFormState[${repairId}] tanımlı değil, oluşturuluyor.`);
                activeFormState[repairId] = { file: null, dataURL: null, quantity: '', date: '', notes: '' };
            }
            
            if (file) {
                console.log(`[handlePhotoInputChange] Dosya seçildi: ${file.name}, Boyut: ${file.size}, Tip: ${file.type}`);
                if (!file.type.match('image/jpeg') && !file.type.match('image/png') && !file.type.match('image/gif') && !file.type.match('image/webp')) {
                    showMessage(t('validImageError'), 'error');
                    event.target.value = null; 
                    if (previewImg) previewImg.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'block';
                    delete activeFormState[repairId].file; 
                    delete activeFormState[repairId].dataURL;
                    console.log(t('photoClearedFromState') + `Geçersiz dosya tipi nedeniyle - Repair ID: ${repairId}`);
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    showMessage(t('fileSizeError'), 'error');
                    event.target.value = null; 
                    if (previewImg) previewImg.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'block';
                    delete activeFormState[repairId].file;
                    delete activeFormState[repairId].dataURL;
                    console.log(t('photoClearedFromState') + `Dosya boyutu büyük olduğu için - Repair ID: ${repairId}`);
                    return;
                }
                
                activeFormState[repairId].file = file; 
                console.log(t('photoSetInState') + `${file.name} - Repair ID: ${repairId}`, activeFormState[repairId].file);

                const reader = new FileReader();
                reader.onload = function(e_reader) {
                    if (previewImg) { 
                        previewImg.src = e_reader.target.result;
                        previewImg.style.display = 'block';
                    }
                    activeFormState[repairId].dataURL = e_reader.target.result; 
                    if (placeholder) { 
                        placeholder.style.display = 'none';
                    }
                    console.log(`[handlePhotoInputChange] FileReader.onload tamamlandı, dataURL ayarlandı - Repair ID: ${repairId}`);
                }
                reader.onerror = function() {
                    console.error(`[handlePhotoInputChange] FileReader hatası - Repair ID: ${repairId}`);
                    showMessage(t('repairError') + ' (Dosya Okuma Hatası)', 'error');
                    delete activeFormState[repairId].file;
                    delete activeFormState[repairId].dataURL;
                     if (previewImg) { previewImg.src = ''; previewImg.style.display = 'none'; }
                     if (placeholder) placeholder.style.display = 'block';
                     console.log(t('photoClearedFromState') + `FileReader hatası nedeniyle - Repair ID: ${repairId}`);
                }
                reader.readAsDataURL(file);
            } else { 
                console.log(`[handlePhotoInputChange] Dosya seçilmedi/iptal edildi - Repair ID: ${repairId}`);
                delete activeFormState[repairId].file;
                delete activeFormState[repairId].dataURL;
                if (previewImg) {
                    previewImg.src = ''; 
                    previewImg.style.display = 'none';
                }
                if (placeholder) placeholder.style.display = 'block';
                console.log(t('photoClearedFromState') + `Dosya seçilmediği için - Repair ID: ${repairId}`);
            }
        }

        async function uploadPhotoToImgur(file) {
            if (!IMGUR_CLIENT_ID || IMGUR_CLIENT_ID === 'YOUR_IMGUR_CLIENT_ID') {
                console.error("Imgur Client ID tanımlı değil.");
                throw new Error(t('repairError') + "Imgur Client ID yapılandırılmamış.");
            }

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: { 'Authorization': `Client-ID ${IMGUR_CLIENT_ID}` },
                    body: formData
                });

                const responseData = await response.json(); 

                if (!response.ok) {
                    console.error('Imgur API Hata Verisi:', responseData);
                    throw new Error(`Imgur yükleme hatası (${response.status}): ${responseData.data?.error?.message || responseData.data?.error || response.statusText}`);
                }

                if (!responseData.success || !responseData.data || !responseData.data.link) {
                    console.error('Imgur API Beklenmeyen Yanıt:', responseData);
                    throw new Error('Imgur API beklenmeyen bir yanıt döndürdü.');
                }
                return responseData.data.link;
            } catch (error) {
                console.error("Imgur fotoğraf yükleme hatası:", error);
                throw error; 
            }
        }

        async function completeRepair(repairId) {
            console.log(`[completeRepair] Tetiklendi - Repair ID: ${repairId}`);
            if (!isFirebaseInitialized) {
                showMessage(t('firebaseError').split(':')[0], 'error');
                return;
            }

            const currentRepairState = activeFormState[repairId]; 
            console.log(`[completeRepair] Repair ID ${repairId} için mevcut form durumu:`, JSON.stringify(currentRepairState, (key, value) => {
                if (key === 'file' && value instanceof File) { return { name: value.name, size: value.size, type: value.type }; }
                return value;
            }));
            
            if (!currentRepairState) {
                console.error(`[completeRepair] HATA: Repair ID ${repairId} için activeFormState bulunamadı!`);
                showMessage(t('repairError') + ` (İç Hata S01 - ${repairId})`, 'error');
                return;
            }
            
            const completedQuantityStr = currentRepairState.quantity !== undefined ? currentRepairState.quantity : document.getElementById(`completed-quantity-${repairId}`).value;
            const completionDate = currentRepairState.date !== undefined ? currentRepairState.date : document.getElementById(`completion-date-${repairId}`).value;
            const completionNotes = (currentRepairState.notes !== undefined ? currentRepairState.notes : document.getElementById(`completion-notes-${repairId}`).value).trim();
            const photoFile = currentRepairState.file; 

            const completedQuantity = parseInt(completedQuantityStr);
            
            if (isNaN(completedQuantity) || completedQuantity < 0) {
                showMessage(t('quantityError'), 'error');
                document.getElementById(`completed-quantity-${repairId}`).focus();
                return;
            }
            
            if (!completionDate) {
                showMessage(t('dateError'), 'error');
                document.getElementById(`completion-date-${repairId}`).focus();
                return;
            }
            
            if (!photoFile) { 
                showMessage(t('photoError'), 'error');
                console.warn(`[completeRepair] FOTOĞRAF DOSYASI EKSİK! Repair ID: ${repairId}. State'deki dosya:`, photoFile);
                return;
            }

            const completeBtn = document.getElementById(`complete-btn-${repairId}`);
            const originalBtnText = completeBtn.innerHTML;
            completeBtn.disabled = true;
            completeBtn.innerHTML = `<div class="loading"></div> ${t('completing')}`;

            try {
                completeBtn.innerHTML = `<div class="loading"></div> ${t('uploadingPhoto')}`;
                const photoURL = await uploadPhotoToImgur(photoFile); 
                
                completeBtn.innerHTML = `<div class="loading"></div> ${t('updatingRecord')}`;
                await db.collection('repairs').doc(repairId).update({
                    completedQuantity: completedQuantity,
                    completionDate: completionDate,
                    completionNotes: completionNotes,
                    completedPhotoURL: photoURL,
                    completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed' 
                });
                
                showMessage(t('repairCompleted'), 'success');
                delete activeFormState[repairId]; 
                
            } catch (error) {
                console.error("Tamir tamamlama hatası:", error);
                showMessage(t('repairError') + error.message, 'error', 7000);
            } finally {
                completeBtn.disabled = false;
                completeBtn.innerHTML = originalBtnText;
            }
        }

        function cancelCompletion(repairId) {
            console.log(`[cancelCompletion] Tetiklendi - Repair ID: ${repairId}`);
            const quantityInput = document.getElementById(`completed-quantity-${repairId}`);
            const notesInput = document.getElementById(`completion-notes-${repairId}`);
            
            if(quantityInput) quantityInput.value = '';
            if(notesInput) notesInput.value = '';

            const photoInput = document.getElementById(`photo-input-${repairId}`);
            if (photoInput) photoInput.value = ''; 
            
            const previewImg = document.getElementById(`photo-preview-${repairId}`);
            const placeholder = document.getElementById(`photo-placeholder-${repairId}`);
            if (previewImg && placeholder) {
                previewImg.src = '';
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
            }
            
            if (activeFormState[repairId]) {
                delete activeFormState[repairId]; 
            }
            showMessage(t('formCleared'), 'info');
        }


        function formatPhoneNumber(phone) {
            if (!phone) return t('unspecified');
            let cleaned = String(phone).replace(/\D/g, '');

            if (cleaned.startsWith('0') && cleaned.length === 11) {
                return `0 (${cleaned.substring(1, 4)}) ${cleaned.substring(4, 7)} ${cleaned.substring(7, 9)} ${cleaned.substring(9, 11)}`;
            }
            if (cleaned.length === 10 && !cleaned.startsWith('90') && cleaned.startsWith('5')) { 
                 return `0 (${cleaned.substring(0, 3)}) ${cleaned.substring(3, 6)} ${cleaned.substring(6, 8)} ${cleaned.substring(8, 10)}`;
            }
            if (cleaned.length === 12 && cleaned.startsWith('90')) {
                return `+${cleaned.substring(0, 2)} (${cleaned.substring(2, 5)}) ${cleaned.substring(5, 8)} ${cleaned.substring(8, 10)} ${cleaned.substring(10, 12)}`;
            }
            
            return phone; 
        }

        function openPhotoModal(imageURL) {
            if (imageURL) {
                document.getElementById('modal-image').src = imageURL;
                document.getElementById('photo-modal').style.display = 'flex';
            }
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').style.display = 'none';
            document.getElementById('modal-image').src = ''; 
        }

        let messageTimeout;
        function showMessage(message, type = 'success', duration = 4000) {
            const existingMessage = document.querySelector('.success-message, .error-message, .info-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : (type === 'error' ? 'error-message' : 'info-message');
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);

            void messageDiv.offsetWidth; 

            messageDiv.style.top = '20px'; 
            messageDiv.style.opacity = '1';

            messageTimeout = setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.top = '-100px'; 
                setTimeout(() => messageDiv.remove(), 500); 
            }, duration);
        }

    </script>
